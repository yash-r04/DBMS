{% extends 'equipment/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">

  <h2 class="mb-4 text-center">Admin Dashboard</h2>

  <!-- Top Stats -->
  <div class="row text-center mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm p-3">
        <h5>Total Equipments</h5>
        <p class="display-6">{{ equipment_count }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm p-3">
        <h5>Suppliers</h5>
        <p class="display-6">{{ supplier_count }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm p-3">
        <h5>Active Usage Records</h5>
        <p class="display-6">{{ borrowed_count }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm p-3">
        <h5>Alerts</h5>
        <p class="display-6 text-danger">{{ alert_count }}</p>
      </div>
    </div>
  </div>

  <!-- Management Buttons -->
  <div class="mb-4 text-center">
    <a href="{% url 'add_equipment' %}" class="btn btn-success mx-1">Add Equipment</a>
    <a href="{% url 'equipment_list' %}" class="btn btn-primary mx-1">View All Equipments</a>
    <a href="{% url 'supplier_list' %}" class="btn btn-info mx-1">View Suppliers</a>
    <a href="{% url 'add_supplier' %}" class="btn btn-warning mx-1">Add Supplier</a>
    <a href="{% url 'admin_users' %}" class="btn btn-dark mx-1">All Users</a>
    <a href="{% url 'admin_staff_list' %}" class="btn btn-secondary mx-1">Staff Users</a>
    <a href="{% url 'admin_borrowers' %}" class="btn btn-outline-danger mx-1">Usage Records</a>
  </div>

  <!-- Charts Row -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm p-4">
        <h5 class="text-center">Equipment Category Distribution</h5>
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm p-4">
        <h5 class="text-center">Borrowed vs Available vs Alerts</h5>
        <canvas id="borrowedChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Active Alerts Table -->
  <div class="card shadow-sm p-4 mt-4">
    <h4 class="mb-3 text-center text-danger">Active Alerts</h4>
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Equipment</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for alert in db_alerts %}
                <tr>
                    <td>{{ alert.equipment.name }}</td>
                    <td>{{ alert.type }}</td>
                    <td>{{ alert.message|default:"-" }}</td>
                    <td>
                        <a href="{% url 'resolve_alert' alert.id 'discard' %}" class="btn btn-sm btn-danger">Discard</a>
                        <a href="{% url 'resolve_alert' alert.id 'add_back' %}" class="btn btn-sm btn-success">Add Back</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center">No active alerts</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
  </div>

  <!-- Low Stock Table -->
  <div class="card shadow-sm p-4 mt-4">
    <h4 class="mb-3 text-center text-warning">Low Stock Equipments</h4>
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Equipment</th>
                    <th>Category</th>
                    <th>Quantity</th>
                    <th>Location</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for eq in low_stock_equipments %}
                <tr>
                    <td>{{ eq.name }}</td>
                    <td>{{ eq.category }}</td>
                    <td>{{ eq.quantity }}</td>
                    <td>{{ eq.location }}</td>
                    <td>
                        <a href="{% url 'add_equipment' %}" class="btn btn-sm btn-primary">Add More</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">No low stock equipments</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Category Chart
  const ctx1 = document.getElementById('categoryChart').getContext('2d');
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: {{ categories|safe }},
      datasets: [{
        label: 'Number of Equipments',
        data: {{ counts|safe }},
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  // Borrowed vs Available vs Alerts Pie Chart
  const borrowedCount = {{ borrowed_count }};
  const totalEquipment = {{ equipment_count }};
  const alertCount = {{ alert_count }};
  const availableCount = Math.max(totalEquipment - borrowedCount, 0); // safe

  const ctx2 = document.getElementById('borrowedChart').getContext('2d');
  new Chart(ctx2, {
    type: 'pie',
    data: {
      labels: ['Borrowed', 'Available', 'Alerts'],
      datasets: [{
        data: [borrowedCount, availableCount, alertCount],
        backgroundColor: [
          'rgba(255, 99, 132, 0.6)',
          'rgba(54, 162, 235, 0.6)',
          'rgba(255, 206, 86, 0.6)'
        ],
        borderWidth: 1
      }]
    },
    options: { responsive: true }
  });
</script>

{% endblock %}
